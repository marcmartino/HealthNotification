<!-- <script src="../javascripts/build/_bower.js"></script> -->
<script src="bower_components/jquery/dist/jquery.js"></script>
<script src="bower_components/lodash/dist/lodash.js"></script>
<script src="bower_components/twig.js/twig.js"></script>
<script src="../javascripts/main.js"></script>

<!doctype html>
<html class="no-js" lang="">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title></title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<link rel="apple-touch-icon" href="apple-touch-icon.png">
		<!-- Place favicon.ico in the root directory -->

		  <link href="../stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css" />
		  <link href="../stylesheets/print.css" media="print" rel="stylesheet" type="text/css" />
		  <!--[if IE]>
		      <link href="../stylesheets/ie.css" media="screen, projection" rel="stylesheet" type="text/css" />
		  <![endif]-->

		<script src="javascripts/vendor/parse-1.3.1.js"></script>
		<script src="javascripts/config.js"></script>
		<script src="javascripts/app.js"></script>

		<script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] +
		':35729/livereload.js?snipver=2"></' + 'script>')</script>

	</head>
	<body>


	</body>
	<script>
		
		var globalUid = "2";
		var navKey = {
			// index: "html/login.html.twig",
			login: "html/login.html.twig",
			register: "html/register.html.twig",
			feed: "html/feed.html.twig",
		}, navTemplObj = {};
		function navigate(location, data) {
			if(navKey[location]) {
				var dataObj = data || {};
				dataObj.nav = {};
				dataObj.nav[location] = true;

				
				if (twig({ref: location})) {
					
					$("body").html(twig({ref: location}).render(dataObj));
				} else {
					twig({
						id: location,
						href: navKey[location],
						load: (function (thisLoc, locUri) {
							return function (temp) {
								
								$("body").html(twig({ref: thisLoc}).render(dataObj));
							};
						}(location, navKey[location])),
					});
				}
			} else {
				console.error("nav failed");
			} 
		}
		$("body").on("click", ".link[data-key]", function (e) {
			e.preventDefault();
			navigate($(this).attr("data-key"));
		});

		navigate("feed");

		var icdNineCodes = {};
		var Diagnosis = Parse.Object.extend("Diagnosis");
		var ICD9 = Parse.Object.extend("ICD9");
		icdQuery = new Parse.Query(ICD9);
		icdQuery.find({
			success: function (codes) {
				icdNineCodes = _.reduce(codes, function (all, code) {
					all[code.attributes.code] = code.attributes.name;
					return all;
				}, {});
				fetchDiagnosisData();
			}
		});

		function fetchDiagnosisData(uid, thenFunc) {
			uid = globalUid || uid;

			var messages = [];
			
			var query = new Parse.Query(Diagnosis);
			query.equalTo("patientId", uid);
			query.find({
			  success: function(diagnosis) {
			    // The object was retrieved successfully.
			    
			    
			    _.forEach(diagnosis, function (singleDiag) {
			    	var thisDiag = singleDiag.attributes;
			    	if (thisDiag.icd9 && icdNineCodes[thisDiag.icd9]) {
			    		thisDiag.codeMessage = icdNineCodes[thisDiag.icd9];
			    	}
			    	thisDiag.updatedAt = singleDiag.updatedAt;
			    	messages.push(singleDiag.attributes);
			    });
			    navigate("feed", {diags: messages});
			  },
			  error: function(object, error) {
			    // The object was not retrieved successfully.
			    // error is a Parse.Error with an error code and message.
			    console.warn("boooo");
			  }
			});

		}

	</script>
</html>